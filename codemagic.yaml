# ==========================================================
# Bible Quest iOS Build â€” Codemagic Workflow
#
# CURRENT MODE: TestFlight Deployment (internal/external testers)
# TO DEPLOY TO APP STORE:
#    1. Set `submit_to_testflight: false`
#    2. Set `submit_to_app_store: true`
#    3. Confirm app metadata and screenshots in App Store Connect
# ==========================================================



workflows:
  biblequest-release:
    name: BibleQuest App Store Build
    max_build_duration: 60
    environment:
      flutter: stable
      xcode: latest
      vars:
        BUNDLE_ID: "app.biblequest"
      groups:
        - appstore_credentials
      node: 18.16.0
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
    scripts:
      - name: Install dependencies
        script: |
          brew install jq
          dotnet workload install maui
      - name: Restore and build
        script: |
          dotnet restore
          dotnet build BibleQuest.sln -c Release -f net8.0-ios
      - name: Publish .ipa
        script: |
          dotnet publish BibleQuest.sln \
            -c Release \
            -f net8.0-ios \
            -p:ApplicationTitle="BibleQuest" \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:CodesignKey=$CERTIFICATE_PRIVATE_KEY \
            -p:CodesignProvision=$PROVISIONING_PROFILE \
            -p:CodesignKeyPassword=$CERTIFICATE_PASSWORD \
            -p:EnableCodeSigning=true \
            -p:GenerateAppBundle=true
    artifacts:
      - build/**/Release/**/BibleQuest.ipa
    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_KEY
        key_id: $APP_STORE_CONNECT_KEY_ID
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
        submit_to_app_store: false
