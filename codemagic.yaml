# ==========================================================
# Bible Quest iOS Build â€” Codemagic Workflow
#
# CURRENT MODE: TestFlight Deployment (internal/external testers)
# TO DEPLOY TO APP STORE:
#    1. Set `submit_to_testflight: false`
#    2. Set `submit_to_app_store: true`
#    3. Confirm app metadata and screenshots in App Store Connect
# ==========================================================


# Bible Quest iOS App â€“ Codemagic YAML for .NET MAUI
# To deploy to App Store later, change `submit_to_testflight` to `submit_to_app_store: true`

workflows:
  bible-quest-ios:
    name: Bible Quest for Kids â€“ iOS Build (.NET MAUI)
    max_build_duration: 60
    environment:
      xcode: latest
      cocoapods: default
      vars:
        DOTNET_ROOT: /usr/local/share/dotnet
        APP_STORE_CONNECT_ISSUER_ID: <your-issuer-id> # ðŸ‘ˆ Already handled in secrets
        APP_STORE_CONNECT_KEY_IDENTIFIER: 3J6J67QJ9K
        APP_STORE_CONNECT_PRIVATE_KEY: Encrypted private key in env
        CERTIFICATE_PRIVATE_KEY: Encrypted .p12 in env
        PROVISIONING_PROFILE: Encrypted .mobileprovision in env
        APP_IDENTIFIER: com.base44.biblequest
        TEAM_ID: 2989BXM365
      groups:
        - app_store_credentials
        - signing_credentials
      node: 18.16.0
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
    scripts:
      - name: Install .NET SDK
        script: |
          brew install --cask dotnet-sdk
          export PATH="/usr/local/share/dotnet:$PATH"
          dotnet --version
      - name: Build bundled web assets (npm)
        script: |
          cd BibleQuestForKids/wwwroot
          npm ci
          npm run build
      - name: Restore & build MAUI app
        script: |
          dotnet workload install maui
          dotnet restore BibleQuestForKids/BibleQuestForKids.csproj
          dotnet build BibleQuestForKids/BibleQuestForKids.csproj -c Release -f net8.0-ios -p:RuntimeIdentifier=ios-arm64 -p:BuildIpa=true
      - name: Package IPA
        script: |
          mkdir -p output
          cp -r **/bin/Release/net8.0-ios/ios-arm64/*.ipa output/
    artifacts:
      - output/*.ipa
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
