name: iOS Build & Deploy (Bible Quest for Kids)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOTNET_VERSION: 8.0.301
  APP_IDENTIFIER: app.biblequest
  APP_DISPLAY_VERSION: 1.1.0 # Reminder: update before App Store submission if marketing version changes

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js for web assets
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install MAUI workloads
        run: dotnet workload install maui-ios --skip-manifest-update

      - name: List existing NuGet sources
        run: dotnet nuget list source

      - name: Ensure nuget.org source exists
        # Guard against duplicate source errors by checking first (GitHub-hosted runners cache NuGet sources).
        run: |
          if ! dotnet nuget list source | grep -q "nuget-org"; then
            dotnet nuget add source https://api.nuget.org/v3/index.json --name nuget-org
          else
            echo "NuGet source 'nuget-org' already registered. Skipping add."
          fi

      - name: Verify configured NuGet sources
        run: dotnet nuget list source

      - name: List repo files for debugging
        run: |
          echo "🔍 Repo root:"
          ls -la
          echo "🔍 BibleQuest folder:"
          ls -la BibleQuest
          echo "🔍 BibleQuestForKids folder:"
          ls -la BibleQuest/BibleQuestForKids

      - name: Restore NuGet packages
        run: dotnet restore BibleQuest/BibleQuestForKids/BibleQuestForKids.csproj --no-cache --disable-parallel --verbosity detailed

      - name: Build bundled web assets
        working-directory: BibleQuest/BibleQuestForKids/wwwroot
        run: |
          npm ci
          npm run build
        env:
          CI: true

      - name: Strip development web assets
        run: |
          rm -rf BibleQuest/BibleQuestForKids/wwwroot/node_modules BibleQuest/BibleQuestForKids/wwwroot/src
          rm -f BibleQuest/BibleQuestForKids/wwwroot/package*.json

      - name: Guard dist assets exist
        run: |
          DIST="BibleQuest/BibleQuestForKids/wwwroot/dist"
          if [ ! -s "$DIST/index.html" ]; then
            echo "dist/index.html missing. Run npm build before publishing." >&2
            exit 1
          fi
          echo "✅ Found dist/index.html"
          head -n 10 "$DIST/index.html"

      - name: Resolve build number (keeps TestFlight builds unique)
        id: resolve-build
        env:
          APP_IDENTIFIER: ${{ env.APP_IDENTIFIER }}
          APP_DISPLAY_VERSION: ${{ env.APP_DISPLAY_VERSION }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          set -euo pipefail
          BUILD_NUMBER=$(date +%s)
          echo "Seeded APP_BUILD_NUMBER=$BUILD_NUMBER from epoch seconds"

          if [ -n "${APP_STORE_CONNECT_PRIVATE_KEY:-}" ] && [ -n "${APP_STORE_CONNECT_KEY_IDENTIFIER:-}" ] && [ -n "${APP_STORE_CONNECT_ISSUER_ID:-}" ]; then
            echo "Checking App Store Connect for safe build number"
            FINAL_BUILD_NUMBER=$(APP_BUILD_NUMBER="$BUILD_NUMBER" \
              APP_DISPLAY_VERSION="$APP_DISPLAY_VERSION" \
              APP_IDENTIFIER="$APP_IDENTIFIER" \
              APP_STORE_CONNECT_PRIVATE_KEY="$APP_STORE_CONNECT_PRIVATE_KEY" \
              APP_STORE_CONNECT_KEY_IDENTIFIER="$APP_STORE_CONNECT_KEY_IDENTIFIER" \
              APP_STORE_CONNECT_ISSUER_ID="$APP_STORE_CONNECT_ISSUER_ID" \
              ruby ci/scripts/maybe_raise_build_number.rb)
          else
            echo "App Store Connect credentials missing. Using epoch build number."
            FINAL_BUILD_NUMBER="$BUILD_NUMBER"
          fi

          if [ -z "$FINAL_BUILD_NUMBER" ]; then
            echo "Failed to resolve build number" >&2
            exit 1
          fi

          echo "APP_BUILD_NUMBER=$FINAL_BUILD_NUMBER" | tee -a "$GITHUB_ENV"

      - name: Install signing assets
        env:
          APPLE_CERTIFICATE_P12_BASE64: ${{ secrets.APPLE_CERTIFICATE_P12_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_PROVISIONING_PROFILE_BASE64: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
        run: |
          set -euo pipefail
          if [ -z "${APPLE_CERTIFICATE_P12_BASE64:-}" ] || [ -z "${APPLE_CERTIFICATE_PASSWORD:-}" ]; then
            echo "Missing APPLE_CERTIFICATE_P12_BASE64 or APPLE_CERTIFICATE_PASSWORD secrets" >&2
            exit 1
          fi

          if [ -z "${APPLE_PROVISIONING_PROFILE_BASE64:-}" ]; then
            echo "Missing APPLE_PROVISIONING_PROFILE_BASE64 secret" >&2
            exit 1
          fi

          KEYCHAIN="signing.keychain-db"
          security create-keychain -p "" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "" "$KEYCHAIN"

          echo "$APPLE_CERTIFICATE_P12_BASE64" | base64 --decode > signing.p12
          security import signing.p12 -k "$KEYCHAIN" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security delete-generic-password -l "signing" "$KEYCHAIN" 2>/dev/null || true

          security list-keychains -s "$KEYCHAIN" $(security list-keychains | tr -d '"')
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN"

          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_DIR"
          PROFILE_PATH="$PROFILE_DIR/${APP_IDENTIFIER}.mobileprovision"
          echo "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"

          CODESIGN_IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN" | head -1 | awk '{print $2}')
          if [ -z "$CODESIGN_IDENTITY" ]; then
            echo "No code signing identity found in imported certificate" >&2
            exit 1
          fi

          {
            echo "CODESIGN_KEY=$CODESIGN_IDENTITY"
            echo "CODESIGN_PROVISION=$PROFILE_PATH"
          } >> "$GITHUB_ENV"

      - name: Publish .NET MAUI iOS app
        run: >-
          dotnet publish BibleQuest/BibleQuestForKids/BibleQuestForKids.csproj
          -c Release
          -f net8.0-ios
          -p:RuntimeIdentifier=ios-arm64
          -p:BuildIpa=true
          -p:ApplicationId=${{ env.APP_IDENTIFIER }}
          -p:CFBundleIdentifier=${{ env.APP_IDENTIFIER }}
          -p:ApplicationDisplayVersion=${{ env.APP_DISPLAY_VERSION }}
          -p:ApplicationVersion=${{ env.APP_BUILD_NUMBER }}
          -p:CodesignKey=${{ env.CODESIGN_KEY }}
          -p:CodesignProvision=${{ env.CODESIGN_PROVISION }}
          -p:CodesignTeamId=${{ secrets.TEAM_ID }}
          --verbosity detailed

      - name: Verify IPA contains dist assets
        run: |
          IPA_PATH=$(find BibleQuest/BibleQuestForKids/bin/Release/net8.0-ios/ios-arm64/publish -name '*.ipa' | head -1)
          unzip -q "$IPA_PATH" -d tmp
          APP_DIR=$(ls tmp/Payload)
          if [ ! -f "tmp/Payload/$APP_DIR/wwwroot/dist/index.html" ]; then
            echo "IPA missing dist/index.html" >&2
            exit 1
          fi
          echo "✅ IPA contains dist/index.html"

      - name: Upload IPA to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: BibleQuest/BibleQuestForKids/bin/Release/net8.0-ios/ios-arm64/publish/*.ipa
          issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          api-key-id: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          api-private-key: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          bundle-id: ${{ env.APP_IDENTIFIER }}

      - name: Archive IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: BibleQuestForKids-ipa
          path: BibleQuest/BibleQuestForKids/bin/Release/net8.0-ios/ios-arm64/publish/*.ipa