name: iOS Build & Deploy (Bible Quest for Kids)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install MAUI workloads
        # Install the MAUI and iOS workloads needed for publishing.
        run: dotnet workload install maui ios

      - name: Configure NuGet sources
        run: |
          dotnet nuget remove source nuget-org || true
          dotnet nuget remove source maui-feed || true
          dotnet nuget add source https://api.nuget.org/v3/index.json -n nuget-org
          dotnet nuget add source https://pkgs.dev.azure.com/dnceng/public/_packaging/maui/nuget/v3/index.json -n maui-feed
          dotnet nuget list source

      - name: Restore NuGet packages
        run: dotnet restore BibleQuestForKids/BibleQuestForKids.sln --no-cache --disable-parallel --verbosity detailed

      - name: Build iOS app
        run: >-
          dotnet build BibleQuestForKids/BibleQuestForKids.csproj
          -c Release
          -f net8.0-ios
          -p:ArchiveOnBuild=true
          -p:RuntimeIdentifier=ios-arm64
          --verbosity detailed

      - name: Publish iOS IPA
        run: >-
          dotnet publish BibleQuestForKids/BibleQuestForKids.csproj
          -c Release
          -f net8.0-ios
          -p:RuntimeIdentifier=ios-arm64
          -p:ArchiveOnBuild=true
          -p:BuildIpa=true
          --verbosity detailed

      - name: Upload IPA to TestFlight
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: BibleQuestForKids/bin/Release/net8.0-ios/ios-arm64/publish/*.ipa
          issuer-id: ${{ secrets.APPLE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPLE_KEY_ID }}
          api-private-key: ${{ secrets.APPLE_PRIVATE_KEY }}
          apple-id: ${{ secrets.APPLE_ID }}
          app-specific-password: ${{ secrets.APP_SPECIFIC_PASSWORD }}
          team-id: ${{ secrets.TEAM_ID }}
